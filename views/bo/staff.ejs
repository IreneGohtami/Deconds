<% include ../header %>
<style>
	#list_data_wrapper {
		width: 100% !important;
	}
</style>
	<div class="container-fluid">
		<div class="row row-offcanvas row-offcanvas-left">
			<% include bo_nav %>
			<main role="main" class="col-sm-12 col-md-9 col-lg-10 ml-sm-auto px-0">
				<% include bo_nav_mobile %><!-- Nav for small screen sm & xs -->
				<div id="main-div" style="display:inline-block !important; width:100%;">
					<h1 class="h2">Staff</h1>
					<hr>
					<div class="btn-toolbar mb-2 mb-md-0 col-sm-12">
						<table id="list_data" class="table table-striped table-bordered table-responsive" style="width:100%;">
							<thead>
								<tr class="text-center">
									<th>No</th>
									<th>ID</th>
									<th>First Name</th>
									<th>Last Name</th>
									<th>Gender</th>
									<!--<th>Date of Birth</th>-->
									<th>Email</th>
									<th>Phone No</th>
									<!--<th>Entry Date</th>-->
									<th>Status</th>
									<th>Branch</th>
									<th>Department</th>
									<th>User Group</th>
									<th>Hierarchy</th>
									<th style="min-width:133px;"></th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</main>
		</div>
	</div>

	<div class="modal fade" id="staffModal" tabindex="-1" role="dialog" aria-labelledby="staffModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staffModalLabel">New Staff</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" style="padding-top:0;">
					<form>
						<div style="background-color:#f6e288; margin:0 -15px 15px; height:40px; padding-top:0.4em;" class="text-center">
							<h5 class="align-middle">Account Details</h5>
						</div>
						<div class="form-group row">
							<div class="col-md-2 col-sm-3">
								<label for="staff_username" class="col-form-label"><span class="required">*</span> Username:</label>
							</div>
							<div class="col-md-4 col-sm-4">
								<input type="text" class="form-control" id="staff_username">
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_password" class="col-form-label"><span class="required">*</span> Password:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<input type="password" class="form-control" id="staff_password">
							</div>
						</div>

						<div style="background-color:#f6e288; margin:0 -15px 15px; height:40px; padding-top:0.4em;" class="text-center">
							<h5 class="align-middle">Personal Details</h5>
						</div>
						<div class="form-group row">
							<div class="col-md-2 col-sm-3">
								<label for="staff_firstname" class="col-form-label"><span class="required">*</span> First Name:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<input type="text" class="form-control" id="staff_firstname">
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_lastname" class="col-form-label"><span class="required">*</span> Last Name:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<input type="text" class="form-control" id="staff_lastname">
							</div>
						</div>
						<div class="form-group row">
							<div class="col-md-2 col-sm-3">
								<label for="staff_email" class="col-form-label"><span class="required">*</span> Email:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<input type="email" class="form-control" id="staff_email">
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_gender" class="col-form-label"><span class="required">*</span> Gender:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_gender">
									<option value="Male">Male</option>
									<option value="Female">Female</option>
								</select>
							</div>
						</div>
						<div class="form-group row">
							<div class="col-md-6 col-sm-6" style="padding:0;">
								<div class="input-group date datetimepicker">
									<div class="col-md-4 col-sm-6" style="padding-right:0;">
										<label for="staff_dob" class="col-form-label">Date of Birth:</label>
									</div>
									<div class="col-md-8 col-sm-6">
										<input type="date" class="form-control" id="staff_dob">
									</div>
								</div>
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_phone" class="col-form-label"><span class="required">*</span> Phone No:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<input type="text" class="form-control" id="staff_phone">
							</div>
						</div>
						<div class="form-group row">
							<div class="col-md-6 col-sm-6" style="padding:0;">
								<div class="input-group date datetimepicker">
									<div class="col-md-4 col-sm-6" style="padding-right:0;">
										<label for="staff_entry_date" class="col-form-label">Entry Date:</label>
									</div>
									<div class="col-md-8 col-sm-6">
										<input type="date" class="form-control" id="staff_entry_date">
									</div>
								</div>
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_status" class="col-form-label"><span class="required">*</span> Status:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_status">
									<option value="Active">Active</option>
									<option value="Inactive">Inactive</option>
								</select>
							</div>
						</div>

						<div style="background-color:#f6e288; margin:0 -15px 15px; height:40px; padding-top:0.4em;" class="text-center">
							<h5 class="align-middle">Staff Details</h5>
						</div>
						<div class="form-group row">
							<div class="col-md-2 col-sm-3">
								<label for="staff_firstname" class="col-form-label"><span class="required">*</span> Branch:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_branch">
									<option value="">Select branch</option>
									<% for(var i=0; i<branchList.length; i++){ %>
										<option value="<%- branchList[i].branch_name %>"><%- branchList[i].branch_name %></option>
									<% } %>
								</select>
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_department" class="col-form-label"><span class="required">*</span> Department:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_department">
									<option value="">Select department</option>
									<% for(var i=0; i<departmentList.length; i++){ %>
										<option value="<%- departmentList[i].department_name %>"><%- departmentList[i].department_name %></option>
									<% } %>
								</select>
							</div>
						</div>
						<div class="form-group row">
							<div class="col-md-2 col-sm-3">
								<label for="staff_usergroup" class="col-form-label"><span class="required">*</span> User Group:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_usergroup">
									<option value="">Select user group</option>
									<% for(var i=0; i<userGroupList.length; i++){ %>
										<option value="<%- userGroupList[i].usergroup_name %>"><%- userGroupList[i].usergroup_name %></option>
									<% } %>
								</select>
							</div>
							<div class="col-md-2 col-sm-3">
								<label for="staff_hierarchy" class="col-form-label"><span class="required">*</span> Hierarchy:</label>
							</div>
							<div class="col-md-4 col-sm-3">
								<select class="form-control" id="staff_hierarchy">
									<option value="">Select hierarchy</option>
									<% for(var i=0; i<hierarchyList.length; i++){ %>
										<option value="<%- hierarchyList[i].hierarchy_name %>"><%- hierarchyList[i].hierarchy_name %></option>
									<% } %>
								</select>
							</div>
						</div>
					</form>
					<span id="error_msg" class="required"></span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="saveBtn" onclick="modifyRecord('')">Save</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteModal" tabindex="-2" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteModalLabel">Delete Staff</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					Are you sure you want to delete <span id="staff-name"></span> from your staff?
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="deleteBtn" onclick="deleteRecord(0, 0, '')">Delete</button>
				</div>
			</div>
		</div>
	</div>

<script>
	$(document).ready(function(){
		$('#list_data').on('processing.dt', function (e, settings, processing) {
			$('#list_data_processing').hide();
			if(processing){
				$.busyLoadFull("show", {
					spinner: "circles"
				});
			}else{
				$.busyLoadFull("hide");
			}
		}).
		DataTable({
			processing: true,
			serverSide: true,
			paging: true,
            pageLength: 10,
			lengthChange: false,
			ajax: "/ajax/list_multi/staff",
			dom: '<"toolbar">frtip',
			language: {                
				infoFiltered: "",
			},
			order: [[ 2, "asc" ]],
			columnDefs: [
				{ "name": "no", "data": "no", "targets": 0, "orderable": false },
				{ "name": "_id", "data": "_id", "targets": 1, "visible": false },
				{ "name": "first_name", "data": "first_name", "targets": 2 },
				{ "name": "last_name", "data": "last_name", "targets": 3 },
				{ "name": "gender", "data": "gender", "targets": 4 },
				{ "name": "email", "data": "email", "targets": 5 },
				{ "name": "phone", "data": "phone", "targets": 6 },
				{ "name": "status", "data": "status", "targets": 7 },
				{ "name": "branch", "data": "staff_details.branch", "targets": 8 },
				{ "name": "department", "data": "staff_details.department", "targets": 9 },
				{ "name": "usergroup", "data": "staff_details.usergroup", "targets": 10 },
				{ "name": "hierarchy", "data": "staff_details.hierarchy", "targets": 11 },
				{ 
					"name": "buttons", "data": null, "targets": 12, "orderable": false,
					"render": function(data, type, full) {
						var fullname = full.first_name + ' ' + full.last_name;
						var str = "<button type='button' class='btn btn-primary' onclick='toggleModal("+JSON.stringify(full)+")'>Edit</button> &nbsp;";
							str += "<button type='button' class='btn btn-primary' onclick='deleteRecord("+full._id+", 1, \""+slashEscape(fullname)+"\")'>Delete</button>";
						return str;
					}
				}
			]
		});
		$("div.toolbar").html('<button class="btn btn-sm btn-outline-secondary float-left" onclick="toggleModal(\'\')">New <span data-feather="plus-circle"></span></button>');
		feather.replace();
	});
	
	function toggleModal(obj){ //console.log(obj);
		if(obj){
			$('#staffModalLabel').text('Edit Staff');
			$('#staff_username').val(obj.username).prop('disabled', true);
			$('#staff_password').val(obj.password).prop('disabled', true);
			$('#staff_firstname').val(obj.first_name);
			$('#staff_lastname').val(obj.last_name);
			$('#staff_gender').val(obj.gender);
			$('#staff_dob').val(obj.dob);
			$('#staff_email').val(obj.email);
			$('#staff_phone').val(obj.phone);
			$('#staff_entry_date').val(obj.entry_date);
			$('#staff_status').val(obj.status);
			$('#staff_branch').val(obj.branch);
			$('#staff_department').val(obj.department);
			$('#staff_usergroup').val(obj.usergroup);
			$('#staff_hierarchy').val(obj.hierarchy);
			
			$('#saveBtn').attr("onclick", "modifyRecord("+obj._id+")");
		}else{
			$('#staffModalLabel').text('New Staff');
			$('#staff_username').val('');
			$('#staff_password').val('');
			$('#staff_firstname').val('');
			$('#staff_lastname').val('');
			$('#staff_gender').val('Male');
			$('#staff_dob').val('');
			$('#staff_email').val('');
			$('#staff_phone').val('');
			$('#staff_entry_date').val('');
			$('#staff_status').val('Active');
			$('#staff_branch').val('');
			$('#staff_department').val('');
			$('#staff_usergroup').val('');
			$('#staff_hierarchy').val('');
			
			$('#saveBtn').attr("onclick", "modifyRecord('')");
		}
		$('#staffModal').modal('show');
	}
	
	function modifyRecord(id){
		$('#error_msg').html('');
		var data = {_id: id, username: $('#staff_username').val(), password: $('#staff_password').val(), first_name: $('#staff_firstname').val(), last_name: $('#staff_lastname').val(), gender: $('#staff_gender').val(), dob: $('#staff_dob').val(), email: $('#staff_email').val(), phone: $('#staff_phone').val(), entry_date: $('#staff_entry_date').val(), status: $('#staff_status').val(), branch: $('#staff_branch').val(), department: $('#staff_department').val(), usergroup: $('#staff_usergroup').val(), hierarchy: $('#staff_hierarchy').val()};

		if(data.username == ''){
			$('#staff_username').prop('required', true);
			$('#staff_username').focus();
			return false;
		}else if(data.password == ''){
			$('#staff_password').prop('required', true);
			$('#staff_password').focus();
			return false;
		}else if(data.first_name == ''){
			$('#staff_firstname').prop('required', true);
			$('#staff_firstname').focus();
			return false;
		}else if(data.last_name == ''){
			$('#staff_lastname').prop('required', true);
			$('#staff_lastname').focus();
			return false;
		}else if(data.email == ''){
			$('#staff_email').prop('required', true);
			$('#staff_email').focus();
			return false;
		}else if(data.phone == ''){
			$('#staff_phone').prop('required', true);
			$('#staff_phone').focus();
			return false;
		}else if(data.branch == ''){
			$('#staff_branch').prop('required', true);
			$('#staff_branch').focus();
			return false;
		}else if(data.department == ''){
			$('#staff_department').prop('required', true);
			$('#staff_department').focus();
			return false;
		}else if(data.usergroup == ''){
			$('#staff_usergroup').prop('required', true);
			$('#staff_usergroup').focus();
			return false;
		}else if(data.hierarchy == ''){
			$('#staff_hierarchy').prop('required', true);
			$('#staff_hierarchy').focus();
			return false;
		}
		else{
			$.busyLoadFull("show", {
				spinner: "circles"
			});
			$.ajax({
				type: 'POST',
				data: data,
				dataType: 'json',
				url: '/modify/staff',						
				success: function(data) {
					if(data.success == true){
						$('#staffModal').modal('hide');
					}else{
						$('#error_msg').html('Error in saving to database.');
					}
					$('#list_data').DataTable().ajax.reload(function(){
						$.busyLoadFull("hide");
					});
				}
			});
		}
	}
	
	function deleteRecord(id, prompt, name){
		if(prompt == 1){
			$('#staff-name').text(name);
			$('#deleteModal').modal('show');
			$('#deleteBtn').attr("onclick", "deleteRecord("+id+", 0, '')");
		}else{
			$.busyLoadFull("show", {
				spinner: "circles"
			});
			var data = {_id: id};
			$.ajax({
				type: 'POST',
				data: data,
				dataType: 'json',
				url: '/delete/staff',						
				success: function(data) {
					if(data.success == true){
						$('#deleteModal').modal('hide');
					}
					$('#list_data').DataTable().ajax.reload(function(){
						$.busyLoadFull("hide");
					});
				}
			});
		}
	}
</script>
	
<% include ../footer %>